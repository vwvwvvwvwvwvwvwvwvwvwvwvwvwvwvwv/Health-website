# ToonFit 开发流程

## 项目概述

ToonFit 是一个健康管理网站，采用 Next.js 16 构建，使用 PostgreSQL 数据库，部署在 Vercel 平台。

## 技术栈

前端使用 Next.js 16 App Router，React 19，TypeScript，Tailwind CSS，Framer Motion 动画库，React Hook Form 表单管理，Zod 数据验证，Recharts 图表库。

后端使用 Next.js Server Actions 处理服务端逻辑，Prisma ORM 管理数据库，PostgreSQL 作为生产数据库。

## 项目结构

prisma 目录包含数据库相关文件，schema.prisma 定义数据模型，seed.ts 填充初始数据，authoritative_data.ts 存储权威的食物和运动数据。

src/app 目录是 Next.js App Router 页面，layout.tsx 是根布局，page.tsx 是首页，HomeClient.tsx 是首页客户端组件，calculator 和 statistics 是其他页面。

src/components 目录包含可复用组件，Navbar 导航栏，FoodMonster 食物怪物动画，ActionPanel 操作面板。

src/lib 目录包含工具函数和服务端逻辑，prisma.ts 配置 Prisma Client，actions.ts 包含所有 Server Actions。

## 数据库设计

Food 模型存储食物信息，包括名称、表情符号和每单位热量值。Exercise 模型存储运动信息，包括名称、表情符号和 MET 值。Log 模型记录用户的饮食和运动记录，包含类型、数量、热量值等。WaterLog 模型记录喝水记录。UserGoal 模型存储用户设置的目标值，包括每日摄入、消耗和喝水目标。

## 核心功能实现

热量计算使用 Mifflin-St Jeor 公式计算 BMR，根据活动水平计算 TDEE。运动消耗使用 MET 值乘以体重和时间计算。食物摄入使用每单位热量乘以数量计算。

所有服务端逻辑都在 actions.ts 中，使用 use server 指令标记。主要函数包括获取选项、获取统计数据、提交记录、添加喝水记录、获取用户目标、更新用户目标、创建自定义食物、搜索食物等。

数据获取流程是 Server Component 调用 Server Actions 获取数据，传递给 Client Component 处理交互，使用 revalidatePath 更新缓存。

## 开发环境搭建

安装 Node.js 18 或更高版本，克隆项目后运行 npm install 安装依赖。创建 .env 文件配置 DATABASE_URL 环境变量，指向 PostgreSQL 数据库。

运行 npx prisma generate 生成 Prisma Client，运行 npx prisma migrate dev 创建数据库表，运行 npx prisma db seed 填充初始数据。

启动开发服务器使用 npm run dev，打开 localhost:3000 查看应用。

## 开发流程

添加新功能时，先在 schema.prisma 中定义数据模型，运行迁移创建表结构，在 actions.ts 中添加 Server Actions，创建或修改页面组件，创建或修改客户端组件处理交互。

修改数据库模型时，修改 schema.prisma，运行迁移更新表结构，更新 seed.ts 和 authoritative_data.ts，重新生成 Prisma Client。

添加新的 Server Action 时，在 actions.ts 中添加函数，使用 prisma 进行数据库操作，使用 revalidatePath 更新缓存。

创建新页面时，在 src/app 目录下创建新文件夹，添加 page.tsx Server Component，创建 Client Component 处理交互。

## 部署流程

项目部署在 Vercel 平台。在 Vercel 控制台连接 GitHub 仓库，导入项目。在项目设置中添加 DATABASE_URL 环境变量，指向生产数据库。

Vercel 会自动识别 vercel.json 配置，构建流程包括安装依赖、生成 Prisma Client、运行数据库迁移、构建 Next.js 应用。

首次部署需要确保数据库已创建并运行迁移。如果数据库是新建的，需要先运行 npx prisma migrate deploy 应用迁移，运行 npx prisma db seed 填充初始数据。

## 常见问题

Prisma Client 未生成时，运行 npx prisma generate。如果问题持续，删除 node_modules 和 package-lock.json，重新安装依赖。

数据库连接失败时，检查 .env 文件中的 DATABASE_URL 是否正确，确认数据库服务是否运行，检查网络连接和防火墙设置。

迁移失败时，检查数据库连接，查看迁移文件是否有语法错误。如果迁移历史不一致，可以重置数据库，仅限开发环境。

构建失败时，检查 vercel.json 配置是否正确，确认环境变量已正确设置，查看构建日志中的具体错误信息。

## 代码规范

使用 TypeScript 严格类型检查，避免使用 any 类型。组件文件使用 PascalCase 命名。Server Components 使用默认导出，Client Components 使用 use client 指令。

页面组件放在 src/app 目录，可复用组件放在 src/components 目录，工具函数和服务端逻辑放在 src/lib 目录。

样式优先使用 Tailwind CSS 工具类，使用 cn 函数合并类名，保持卡通风格的一致性。

Server Actions 放在 actions.ts 中，使用 use server 指令，使用 revalidatePath 更新缓存，处理错误并返回适当的错误信息。

